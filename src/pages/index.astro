---
import Layout from "../layouts/Layout.astro";
import {getCollection} from "astro:content";
import Post from "../components/Post.astro";
import "@fontsource/pacifico";

const posts = await getCollection('posts', (post) =>
    import.meta.env.PROD ? !post.data.draft : true
);
posts.sort((a, b) => b.data.date - a.data.date);
---

<Layout title="Notes of Matthias">
  <section
    id="hero"
    class="fixed inset-0 z-50 flex flex-col items-center justify-center hero-bg"
    aria-label="Hi there, I am Matthias"
  >
    <canvas id="particles-canvas" class="absolute inset-0 w-full h-full z-0" aria-hidden="true" style="cursor: crosshair;"></canvas>
    <div id="hero-content" class="flex flex-col items-center gap-8 p-4 relative z-10" style="transform: translateY(-220px);">
      <img
        id="profile-img"
        src="/me.jpg"
        alt="Matthias"
        class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover profile-glow"
      />
    </div>

    <button
      id="enter-btn"
      class="absolute bottom-12 p-2 rounded-full text-white bg-transparent border-none cursor-pointer enter-btn hover:bg-white/10 focus:outline-2 focus:outline-white focus:outline-offset-4"
      aria-label="Enter site"
    >
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14M5 12l7 7 7-7"/>
      </svg>
    </button>
  </section>

  <main id="main-content" class="min-h-screen focus:outline-none" tabindex="-1">
    <div class="mx-auto pt-8 max-w-3xl prose-xl p-4 border-b pb-12">
      <h1 class="font-bold">Hey!</h1>
      <p class="text-2xl">
        My name is Matthias, welcome to my notes. I am
        a software developer based in northern Germany. On here,
        I write down some thoughts, explorations and things I have learned.
      </p>
      <p class="text-2xl mt-2">Have fun!</p>
    </div>
    <div class="mx-auto max-w-3xl prose p-4">
      {posts.map((post) => <Post post={post} />)}
    </div>
  </main>
</Layout>

<script>
  import { createParticleLifeSystem } from '../lib/particle-life';

  const hero = document.getElementById('hero');
  const enterBtn = document.getElementById('enter-btn');
  const mainContent = document.getElementById('main-content');
  const particlesCanvas = document.getElementById('particles-canvas') as HTMLCanvasElement | null;
  const heroContent = document.getElementById('hero-content') as HTMLElement | null;
  const profileImg = document.getElementById('profile-img') as HTMLImageElement | null;

  if (hero && enterBtn && mainContent && particlesCanvas && heroContent && profileImg) {
    let revealed = false;
    const particleSystem = createParticleLifeSystem(particlesCanvas);

    const reveal = () => {
      if (revealed) return;
      revealed = true;
      particleSystem?.stop();
      hero.classList.add('hero-exit');
      hero.addEventListener('animationend', () => {
        hero.style.display = 'none';
        mainContent.focus();
        cleanup();
      }, { once: true });
    };

    // Start particles immediately
    let ready = false;
    particleSystem?.start();

    // After 3 seconds (first message hold duration), fade out the image as particles start to dissolve
    const timer = setTimeout(() => {
      profileImg.style.transition = 'opacity 1s ease-out';
      profileImg.style.opacity = '0';
      ready = true;
    }, 3000);

    const onWheel = (e: WheelEvent) => { if (ready && e.deltaY > 0) reveal(); };
    const onKey = (e: KeyboardEvent) => { if (ready && ['ArrowDown', 'PageDown', ' '].includes(e.key)) reveal(); };
    let touchY = 0;
    const onTouchStart = (e: TouchEvent) => { touchY = e.touches[0].clientY; };
    const onTouchEnd = (e: TouchEvent) => { if (ready && touchY - e.changedTouches[0].clientY > 50) reveal(); };

    const onResize = () => {
      particleSystem?.resize();
    };

    enterBtn.addEventListener('click', reveal);
    window.addEventListener('wheel', onWheel, { passive: true });
    window.addEventListener('keydown', onKey);
    window.addEventListener('touchstart', onTouchStart, { passive: true });
    window.addEventListener('touchend', onTouchEnd, { passive: true });
    window.addEventListener('resize', onResize);

    const cleanup = () => {
      clearTimeout(timer);
      window.removeEventListener('wheel', onWheel);
      window.removeEventListener('keydown', onKey);
      window.removeEventListener('touchstart', onTouchStart);
      window.removeEventListener('touchend', onTouchEnd);
      window.removeEventListener('resize', onResize);
    };
  }
</script>

<style>
  .hero-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); }
  .profile-glow { box-shadow: 0 0 60px rgba(124, 58, 237, 0.3); }
  .hero-exit { animation: slideUp 0.6s ease-in-out forwards; }
  @keyframes slideUp { to { transform: translateY(-100%); } }

  .enter-btn {
    opacity: 0;
    animation: fadeIn 0.5s ease-out 3s forwards, bounce 1.5s ease-in-out 3.5s infinite;
  }
  @keyframes fadeIn { to { opacity: 1; } }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(10px); } }

  @media (prefers-reduced-motion: reduce) {
    .enter-btn { animation: none; opacity: 1; }
    .hero-exit { animation: none; display: none; }
  }
</style>
